<template>
    <lightning-card title="Invoice Dashboard" icon-name="standard:dashboard">
        <div class="slds-p-around_small">
            <lightning-layout horizontal-align="space">
                <lightning-layout-item padding="around-small" size="3">
                    <lightning-combobox
                        name="dateFilter"
                        label="Date"
                        value={dateFilter}
                        options={dateRangeOptions}
                        onchange={handleFilterChange}
                        disabled={hasCustomDateRange}
                        placeholder={dateFilterPlaceholder}
                    ></lightning-combobox>
                </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="2">
                    <div class={startDateContainerClass}>
                        <lightning-input
                            type="date"
                            name="startDate"
                            label="Start Date"
                            value={startDate}
                            onchange={handleDateRangeChange}
                        ></lightning-input>
                        <template if:true={startDate}>
                            <lightning-button-icon
                                icon-name="utility:clear"
                                variant="bare"
                                size="small"
                                alternative-text="Clear Start Date"
                                title="Clear Start Date"
                                onclick={clearStartDate}
                                class="clear-date-button"
                            ></lightning-button-icon>
                        </template>
                    </div>
                </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="2">
                    <div class={endDateContainerClass}>
                        <lightning-input
                            type="date"
                            name="endDate"
                            label="End Date"
                            value={endDate}
                            onchange={handleDateRangeChange}
                        ></lightning-input>
                        <template if:true={endDate}>
                            <lightning-button-icon
                                icon-name="utility:clear"
                                variant="bare"
                                size="small"
                                alternative-text="Clear End Date"
                                title="Clear End Date"
                                onclick={clearEndDate}
                                class="clear-date-button"
                            ></lightning-button-icon>
                        </template>
                    </div>
                </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="5">
                    <lightning-combobox
                        name="teamFilter"
                        label="Team"
                        value={teamFilter}
                        options={teamOptions}
                        onchange={handleFilterChange}
                    ></lightning-combobox>
                </lightning-layout-item>
            </lightning-layout>
        </div>

        <template if:true={hasValidDateSelection}>
            <div class="slds-p-around_medium">
                <lightning-layout horizontal-align="space">
                    <lightning-layout-item padding="around-small" size="3">
                        <div class="metric-card total-invoiced clickable-card" onclick={handleTotalInvoicedClick}>
                            <div class="metric-title">Total Amount Invoiced</div>
                            <div class="metric-value">
                                <lightning-formatted-number
                                    value={totalInvoicedTruncated}
                                    format-style="currency"
                                    currency-code="USD"
                                    minimum-fraction-digits="0"
                                    maximum-fraction-digits="0"
                                ></lightning-formatted-number>
                            </div>
                            <lightning-icon icon-name="utility:chevronright" size="small" class="card-chevron"></lightning-icon>
                        </div>
                    </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="3">
                    <div class="metric-card payments-received clickable-card" onclick={handlePaymentsReceivedClick}>
                        <div class="metric-title">Invoice Payments Received</div>
                        <div class="metric-value">
                            <lightning-formatted-number
                                value={paymentsReceivedTruncated}
                                format-style="currency"
                                currency-code="USD"
                                minimum-fraction-digits="0"
                                maximum-fraction-digits="0"
                            ></lightning-formatted-number>
                        </div>
                        <lightning-icon icon-name="utility:chevronright" size="small" class="card-chevron"></lightning-icon>
                    </div>
                </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="3">
                    <div class="metric-card outstanding-balance clickable-card" onclick={handleOutstandingBalanceClick}>
                        <div class="metric-title">Outstanding Balance</div>
                        <div class="metric-value">
                            <lightning-formatted-number
                                value={outstandingBalanceTruncated}
                                format-style="currency"
                                currency-code="USD"
                                minimum-fraction-digits="0"
                                maximum-fraction-digits="0"
                            ></lightning-formatted-number>
                        </div>
                        <lightning-icon icon-name="utility:chevronright" size="small" class="card-chevron"></lightning-icon>
                    </div>
                </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="3">
                    <div class="metric-card collection-rate clickable-card" onclick={handleCollectionRateClick}>
                        <div class="metric-title">Collection Rate</div>
                        <div class="metric-value">
                            {collectionRate}%
                        </div>
                        <lightning-icon icon-name="utility:chevronright" size="small" class="card-chevron"></lightning-icon>
                    </div>
                </lightning-layout-item>
            </lightning-layout>
        </div>

        <div class="slds-p-around_medium">
            <lightning-layout horizontal-align="space">
                <lightning-layout-item padding="around-small" size="3">
                    <lightning-card title="Total Invoiced by Team" class="chart-card">
                        <div class="chart-container">
                            <canvas class="totalInvoicedChart" lwc:dom="manual"></canvas>
                        </div>
                    </lightning-card>
                </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="3">
                    <lightning-card title="Invoice Payments Received by Team" class="chart-card">
                        <div class="chart-container">
                            <canvas class="paymentsReceivedChart" lwc:dom="manual"></canvas>
                        </div>
                    </lightning-card>
                </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="3">
                    <lightning-card title="Outstanding Balance by Team" class="chart-card">
                        <div class="chart-container">
                            <canvas class="outstandingBalanceChart" lwc:dom="manual"></canvas>
                        </div>
                    </lightning-card>
                </lightning-layout-item>
                <lightning-layout-item padding="around-small" size="3">
                    <lightning-card title="Collection Rate by Team" class="chart-card">
                        <div class="chart-container">
                            <canvas class="collectionRateChart" lwc:dom="manual"></canvas>
                        </div>
                    </lightning-card>
                </lightning-layout-item>
            </lightning-layout>
        </div>
        </template>
    </lightning-card>

    <!-- Invoice Details Modal -->
    <template if:true={showModal}>
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 id="modal-heading-01" class="slds-modal__title slds-hyphenate">{modalTitle}</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <template if:true={isLoadingModal}>
                        <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                    </template>
                    <template if:false={isLoadingModal}>
                        <!-- CSV Download Button -->
                        <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                            <div class="slds-col">
                                <lightning-button
                                    variant="brand"
                                    label="Download CSV"
                                    icon-name="utility:download"
                                    onclick={handleDownloadCSV}
                                ></lightning-button>
                            </div>
                        </div>
                        
                        <!-- Top Pagination Controls -->
                        <template if:true={hasMultiplePages}>
                            <div class="slds-p-around_small slds-border_bottom">
                                <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                                    <div class="slds-col">
                                        <span class="slds-text-body_small">{pageInfo}</span>
                                    </div>
                                    <div class="slds-col slds-no-flex">
                                        <div class="slds-button-group" role="group">
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" 
                                                    onclick={handleFirstPage} 
                                                    disabled={isLoadingModal}
                                                    title="First Page">
                                                <lightning-icon icon-name="utility:chevronleft" size="x-small"></lightning-icon>
                                                <lightning-icon icon-name="utility:chevronleft" size="x-small" class="slds-m-left_xxx-small"></lightning-icon>
                                                <span class="slds-assistive-text">First Page</span>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" 
                                                    onclick={handlePreviousPage} 
                                                    disabled={isLoadingModal}
                                                    title="Previous Page">
                                                <lightning-icon icon-name="utility:chevronleft" size="x-small"></lightning-icon>
                                                <span class="slds-assistive-text">Previous Page</span>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" 
                                                    onclick={handleNextPage} 
                                                    disabled={isLoadingModal}
                                                    title="Next Page">
                                                <lightning-icon icon-name="utility:chevronright" size="x-small"></lightning-icon>
                                                <span class="slds-assistive-text">Next Page</span>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" 
                                                    onclick={handleLastPage} 
                                                    disabled={isLoadingModal}
                                                    title="Last Page">
                                                <lightning-icon icon-name="utility:chevronright" size="x-small"></lightning-icon>
                                                <lightning-icon icon-name="utility:chevronright" size="x-small" class="slds-m-left_xxx-small"></lightning-icon>
                                                <span class="slds-assistive-text">Last Page</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <lightning-datatable
                            key-field="invoiceId"
                            data={invoiceDetails}
                            columns={columns}
                            hide-checkbox-column="true"
                            onrowaction={handleRowAction}
                        ></lightning-datatable>
                        
                        <!-- Pagination Controls -->
                        <template if:true={hasMultiplePages}>
                            <div class="slds-p-around_small slds-border_top">
                                <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                                    <div class="slds-col">
                                        <span class="slds-text-body_small">{pageInfo}</span>
                                    </div>
                                    <div class="slds-col slds-no-flex">
                                        <div class="slds-button-group" role="group">
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" 
                                                    onclick={handleFirstPage} 
                                                    disabled={isLoadingModal}
                                                    title="First Page">
                                                <lightning-icon icon-name="utility:chevronleft" size="x-small"></lightning-icon>
                                                <lightning-icon icon-name="utility:chevronleft" size="x-small" class="slds-m-left_xxx-small"></lightning-icon>
                                                <span class="slds-assistive-text">First Page</span>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" 
                                                    onclick={handlePreviousPage} 
                                                    disabled={isLoadingModal}
                                                    title="Previous Page">
                                                <lightning-icon icon-name="utility:chevronleft" size="x-small"></lightning-icon>
                                                <span class="slds-assistive-text">Previous Page</span>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" 
                                                    onclick={handleNextPage} 
                                                    disabled={isLoadingModal}
                                                    title="Next Page">
                                                <lightning-icon icon-name="utility:chevronright" size="x-small"></lightning-icon>
                                                <span class="slds-assistive-text">Next Page</span>
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" 
                                                    onclick={handleLastPage} 
                                                    disabled={isLoadingModal}
                                                    title="Last Page">
                                                <lightning-icon icon-name="utility:chevronright" size="x-small"></lightning-icon>
                                                <lightning-icon icon-name="utility:chevronright" size="x-small" class="slds-m-left_xxx-small"></lightning-icon>
                                                <span class="slds-assistive-text">Last Page</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>
                <footer class="slds-modal__footer">
                    <button class="slds-button slds-button_neutral" onclick={closeModal}>Close</button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>